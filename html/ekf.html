<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NASA Astrobee Robot Software: GNC EKF Wrapper</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.png" type="image/png" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="freeflyer.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td id="projectlogo"><img alt="Logo" src="astrobee-logo.png" height="100"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NASA Astrobee Robot Software
   &#160;<span id="projectnumber">0.13.0</span>
   </div>
   <div id="projectbrief">Flight software for the Astrobee robot operating inside the International Space Station.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ekf.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">GNC EKF Wrapper </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The extended kalman filter tracks the robot's pose.</p>
<h1><a class="anchor" id="autotoc_md205"></a>
Overview</h1>
<p>The EKF is based on the augmented state extended kalman filter by Mourikis et. al. We localize from <a class="el" href="structIMU.html">IMU</a> readings and visual odometry, together with one of sparse map features, AR tags, or handrail detections. Only one of these last features can be used at a time. The filter has three main steps:</p>
<ul>
<li><b>Predict</b>: With every <a class="el" href="structIMU.html">IMU</a> measurement, the EKF forward predicts the robot's motion based on the <a class="el" href="structIMU.html">IMU</a> measurement (linear acceleration and angular velocity). The predict step must be run a constant rate (currently 62.5 Hz). Every iteration of the loop must run at this rate, so the performance of the code is critical.</li>
<li><b>Registration</b>: Camera images cannot be process within one iteration of the predict step. Hence, we have a registration step when an image is captured. When a registration pulse is sent to GNC, the EKF state is <em>augmented</em>, and we remember the robot's pose when the image was captured, and capture the covariance to the rest of the state.</li>
<li><b>Update</b>: When an image is processsed, an observation is used to update the state.</li>
</ul>
<p>For more details on how the EKF works, see our paper, <em>Localization from Visual Landmarks on a Free-Flying Robot. Brian Coltin, Jesse Fusco, Zack Moratto, Oleg Alexandrov, and Robert Nakamura. IROS 2016</em>.</p>
<h1><a class="anchor" id="autotoc_md206"></a>
Inputs</h1>
<ul>
<li><a class="el" href="structIMU.html">IMU</a> Readings, <code>/hw/imu</code>: The <a class="el" href="structIMU.html">IMU</a> message. Must be received at a constant rate.</li>
<li>Sparse Map Features, <code>/loc/ml/features</code> and <code>/loc/ml/registration</code>: The features and registration pulses from the sparse map. The features include image coordinates and corresponding 3D feature positions from the map.</li>
<li>AR <a class="el" href="structTag.html">Tag</a> Features, <code>/loc/ar/features</code> and <code>/loc/ar/registration</code>: The same as the sparse map features, but for AR tags. These are assumed to come from the dock camera.</li>
<li>Optical Flow Features: <code>/loc/of/features</code> and <code>/loc/of/registration</code>: These features are used for visual odometry. They are not associated with a 3D position, but are tracked over time with a unique associated ID. Inside the EKF wrapper we keep track of these points over time and send appropriate features to the EKF.</li>
<li>Handrail Features: <code>/loc/handrail/features</code> and <code>/loc/handrail/registration</code>: The features for localization with respect to the handrail. These are point features like with the sparse map features, but also include a direction of the handrail axis and a boolean indicating whether the position along this axis has been observed.</li>
</ul>
<h1><a class="anchor" id="autotoc_md207"></a>
Outputs</h1>
<ul>
<li><code>/gnc/ekf</code>, the body state. See the EkfState message documentation for details.</li>
<li>The body tf2 transform.</li>
</ul>
<h1><a class="anchor" id="autotoc_md208"></a>
Services</h1>
<ul>
<li><code>/gnc/ekf/reset</code>: Resets the EKF, setting the pose based on the next incoming visual landmarks.</li>
<li><code>/gnc/ekf/initialize_bias</code>: Observes the accelerometer readings over the next several seconds, sets the bias, and resets the EKF. This must only be called when the robot is stationary!</li>
<li><code>/gnc/ekf/set_input</code>: Switches the input mode of the EKF between sparse map features, AR tags, and handrail features. Only one of these inputs can be used at a time. However, visual odometry is always active.</li>
</ul>
<h1><a class="anchor" id="autotoc_md209"></a>
Threading Model</h1>
<p>For good pose tracking, it is key to eliminate latency in <a class="el" href="structIMU.html">IMU</a> measurements and camera registrations. That is why we use a multi-threaded ROS node, in which all of the subscriptions record incoming data in a non-blocking manner. A separate thread loops continuously and runs the GNC autocode step function whenever a new <a class="el" href="structIMU.html">IMU</a> measurement is received (informed via a condition variable). This allows us to guarantee that all received registration pulses and updates will be processed on the next tick.</p>
<p>Note that each step of the EKF must run within one <a class="el" href="structIMU.html">IMU</a> tick, or serious problems will arise. All of the ROS subscriptions and threading code is put in <code><a class="el" href="ekf__wrapper_8cc.html">ekf_wrapper.cc</a></code>, while the core functionality is presented in <code>ekf.cc</code>. This way the class in <code>ekf.cc</code> can be used in other ways, for example, when processing a bag file.</p>
<h1><a class="anchor" id="autotoc_md210"></a>
Selecting Visual Odometry Features</h1>
<p>Largely, the EKF wrapper simply passes the inputs directly to the GNC matlab code. The one exception is the visual odometry features. Here, the wrapper keeps track of which augmentations are stored in the EKF, and the feature observations during those observations. It chooses which augmentations to send to the EKF when, and then deletes the sent features and chooses new augmentations. The goals are to send features spanning as wide as possible a period of time, to drive the covariance down, and to never send the same observation twice (because this results in overconfidence). </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
</body>
</html>
